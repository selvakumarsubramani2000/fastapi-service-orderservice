# FastapiServiceOrderservice Azure DevOps Pipeline
# Generated by Golden Path Generator

trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  pythonVersion: '3.11'
  serviceName: 'fastapi-service-orderservice'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: Build
        displayName: 'Build'
        steps:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '$(pythonVersion)'
            displayName: 'Use Python $(pythonVersion)'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              pip install pytest pytest-cov
              pytest tests/ --cov=src --cov-report=xml --junitxml=test-results.xml
            displayName: 'Run tests'

          - task: PublishTestResults@2
            inputs:
              testResultsFiles: 'test-results.xml'
              testRunTitle: 'Python Tests'
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@1
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: 'coverage.xml'
            condition: succeededOrFailed()

  - stage: Docker
    displayName: 'Build Docker Image'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Docker
        displayName: 'Build and Push'
        steps:
          - task: Docker@2
            inputs:
              command: 'build'
              Dockerfile: 'Dockerfile'
              tags: |
                $(Build.BuildId)
                latest
            displayName: 'Build Docker image'

  - stage: Deploy
    displayName: 'Deploy to Environment'
    dependsOn: Docker
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: Deploy
        displayName: 'Deploy'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: echo "Deploy to Kubernetes"
                  displayName: 'Deploy'
